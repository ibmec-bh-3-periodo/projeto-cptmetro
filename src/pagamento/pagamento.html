<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Compra de Tickets - Metrô</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Jost:wght@400;600&display=swap" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="pagamento.css">
</head>
<body>
  <header>
    <h1>Compra de Tickets - Metrô São Paulo</h1>
  </header>

  <div class="main-container">
    <h2>Selecione a quantidade de tickets</h2>
    <div class="pagamento-box">
      <label for="quantidade-tickets">Tickets:</label>
      <input type="number" id="quantidade-tickets" min="1" max="20" value="1" />
      <p id="valor-total">Valor total: R$ 4,40</p>

      <div class="pix-section">
        <p><i class="fa-brands fa-pix"></i> Chave PIX para pagamento:</p>
        <div class="pix-container">
          <input type="text" id="pix-key" readonly value="pix-metro@cptm.com" />
          <button id="copy-pix-btn">Copiar</button>
        </div>
        <span id="copy-msg" class="copy-message"></span>
      </div>

      <button id="confirmar-pagamento-btn">Confirmar Pagamento</button>
      <span id="confirmacao-compra" class="copy-message"></span>
    </div>
  </div>

<footer>
        <div class="footer-container">
            <div class="footer-icons">
                <a href="../homepage/home.html" class="link"><img src="../icones/home.png" alt="ícone de home"></a>
                <a href="../qrcode/qrcode.html" class="link"><img src="../icones/bilhete.png" alt="ícone de qr code"></a>
                <a href="../mapa/mapa.html" class="link"><img src="../icones/mapa.png" alt="ícone de mapa"></a>
                <a href="../configuração/config.html" class="link"><img src="../icones/configuracoes.png" alt="ícone de configurações"></a>
            </div>
            <p>&copy; 2024 Site do Metrô. Todos os direitos reservados.</p>
        </div>
    </footer>
  <script>
    const quantidadeInput = document.getElementById("quantidade-tickets");
    const valorTotal = document.getElementById("valor-total");
    const valorUnitario = 4.40;

    quantidadeInput.addEventListener("input", () => {
      const qtd = parseInt(quantidadeInput.value);
      valorTotal.textContent = `Valor total: R$ ${(qtd * valorUnitario).toFixed(2)}`;
    });

    document.getElementById("copy-pix-btn").addEventListener("click", () => {
      const pixInput = document.getElementById("pix-key");
      pixInput.select();
      document.execCommand("copy");
      document.getElementById("copy-msg").textContent = "Chave copiada!";
      setTimeout(() => document.getElementById("copy-msg").textContent = "", 2000);
    });

    document.getElementById("confirmar-pagamento-btn").addEventListener("click", async function () {
      const user = JSON.parse(localStorage.getItem("user"));
      const ticketsToAdd = parseInt(quantidadeInput.value);

      if (!user) {
        alert("Você precisa estar logado para comprar tickets!");
        return;
      }

      try {
        const response = await fetch(`http://localhost:3000/usuarios/${user.email}/tickets`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ tickets: ticketsToAdd })
        });

        if (response.ok) {
          const updatedUser = await response.json();
          localStorage.setItem("user", JSON.stringify(updatedUser));
          document.getElementById("confirmacao-compra").textContent = "Pagamento confirmado!";
          setTimeout(() => document.getElementById("confirmacao-compra").textContent = "", 3000);
        } else {
          alert("Erro ao processar o pagamento!");
        }
      } catch (error) {
        console.error("Erro ao confirmar pagamento:", error);
        alert("Erro inesperado.");
      }
    });
  </script>
</body>
</html>
